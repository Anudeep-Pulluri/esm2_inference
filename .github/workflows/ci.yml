name: CI

on: [push]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # Step 2: Set up Python environment
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      # Step 3: Install dependencies (including flake8 and kubeconform)
      - name: Install dependencies
        run: |
          pip install pytest flake8 torch torchvision torchaudio transformers fastapi uvicorn

      # Step 4: Run linting (flake8)
      - name: Run linting
        run: |
          # Fail on syntax or critical errors
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          # Warn (but donâ€™t fail) on style issues
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      # Step 5: Run tests (pytest)
      - name: Run tests
        run: pytest -v

      # Step 6: Validate Kubernetes manifests using kubeconform
      - name: Validate Kubernetes manifests
        run: |
          curl -L https://github.com/yannh/kubeconform/releases/latest/download/kubeconform-linux-amd64.tar.gz \
            | tar xz && ./kubeconform -summary deployment.yaml service.yaml